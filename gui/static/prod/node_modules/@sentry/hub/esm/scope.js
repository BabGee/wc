import*as tslib_1 from"../../../tslib/tslib.es6.js";import{getGlobalObject,isThenable,normalize,SyncPromise,timestampWithMs}from"../../utils/esm/index.js";var Scope=function(){function Scope(){this._notifyingListeners=!1;this._scopeListeners=[];this._eventProcessors=[];this._breadcrumbs=[];this._user={};this._tags={};this._extra={};this._context={}}Scope.prototype.addScopeListener=function(callback){this._scopeListeners.push(callback)};Scope.prototype.addEventProcessor=function(callback){this._eventProcessors.push(callback);return this};Scope.prototype._notifyScopeListeners=function(){var _this=this;if(!this._notifyingListeners){this._notifyingListeners=!0;setTimeout(function(){_this._scopeListeners.forEach(function(callback){callback(_this)});_this._notifyingListeners=!1})}};Scope.prototype._notifyEventProcessors=function(processors,event,hint,index){var _this=this;if(void 0===index){index=0}return new SyncPromise(function(resolve,reject){var processor=processors[index];if(null===event||"function"!==typeof processor){resolve(event)}else{var result=processor(tslib_1.__assign({},event),hint);if(isThenable(result)){result.then(function(final){return _this._notifyEventProcessors(processors,final,hint,index+1).then(resolve)}).then(null,reject)}else{_this._notifyEventProcessors(processors,result,hint,index+1).then(resolve).then(null,reject)}}})};Scope.prototype.setUser=function(user){this._user=normalize(user);this._notifyScopeListeners();return this};Scope.prototype.setTags=function(tags){this._tags=tslib_1.__assign({},this._tags,normalize(tags));this._notifyScopeListeners();return this};Scope.prototype.setTag=function(key,value){var _a;this._tags=tslib_1.__assign({},this._tags,(_a={},_a[key]=normalize(value),_a));this._notifyScopeListeners();return this};Scope.prototype.setExtras=function(extra){this._extra=tslib_1.__assign({},this._extra,normalize(extra));this._notifyScopeListeners();return this};Scope.prototype.setExtra=function(key,extra){var _a;this._extra=tslib_1.__assign({},this._extra,(_a={},_a[key]=normalize(extra),_a));this._notifyScopeListeners();return this};Scope.prototype.setFingerprint=function(fingerprint){this._fingerprint=normalize(fingerprint);this._notifyScopeListeners();return this};Scope.prototype.setLevel=function(level){this._level=normalize(level);this._notifyScopeListeners();return this};Scope.prototype.setTransaction=function(transaction){this._transaction=transaction;this._notifyScopeListeners();return this};Scope.prototype.setContext=function(name,context){this._context[name]=context?normalize(context):void 0;this._notifyScopeListeners();return this};Scope.prototype.setSpan=function(span){this._span=span;this._notifyScopeListeners();return this};Scope.prototype.getSpan=function(){return this._span};Scope.clone=function(scope){var newScope=new Scope;if(scope){newScope._breadcrumbs=tslib_1.__spread(scope._breadcrumbs);newScope._tags=tslib_1.__assign({},scope._tags);newScope._extra=tslib_1.__assign({},scope._extra);newScope._context=tslib_1.__assign({},scope._context);newScope._user=scope._user;newScope._level=scope._level;newScope._span=scope._span;newScope._transaction=scope._transaction;newScope._fingerprint=scope._fingerprint;newScope._eventProcessors=tslib_1.__spread(scope._eventProcessors)}return newScope};Scope.prototype.clear=function(){this._breadcrumbs=[];this._tags={};this._extra={};this._user={};this._context={};this._level=void 0;this._transaction=void 0;this._fingerprint=void 0;this._span=void 0;this._notifyScopeListeners();return this};Scope.prototype.addBreadcrumb=function(breadcrumb,maxBreadcrumbs){var timestamp=timestampWithMs(),mergedBreadcrumb=tslib_1.__assign({timestamp:timestamp},breadcrumb);this._breadcrumbs=maxBreadcrumbs!==void 0&&0<=maxBreadcrumbs?tslib_1.__spread(this._breadcrumbs,[normalize(mergedBreadcrumb)]).slice(-maxBreadcrumbs):tslib_1.__spread(this._breadcrumbs,[normalize(mergedBreadcrumb)]);this._notifyScopeListeners();return this};Scope.prototype.clearBreadcrumbs=function(){this._breadcrumbs=[];this._notifyScopeListeners();return this};Scope.prototype._applyFingerprint=function(event){event.fingerprint=event.fingerprint?Array.isArray(event.fingerprint)?event.fingerprint:[event.fingerprint]:[];if(this._fingerprint){event.fingerprint=event.fingerprint.concat(this._fingerprint)}if(event.fingerprint&&!event.fingerprint.length){delete event.fingerprint}};Scope.prototype.applyToEvent=function(event,hint){if(this._extra&&Object.keys(this._extra).length){event.extra=tslib_1.__assign({},this._extra,event.extra)}if(this._tags&&Object.keys(this._tags).length){event.tags=tslib_1.__assign({},this._tags,event.tags)}if(this._user&&Object.keys(this._user).length){event.user=tslib_1.__assign({},this._user,event.user)}if(this._context&&Object.keys(this._context).length){event.contexts=tslib_1.__assign({},this._context,event.contexts)}if(this._level){event.level=this._level}if(this._transaction){event.transaction=this._transaction}if(this._span){event.contexts=event.contexts||{};event.contexts.trace=this._span.getTraceContext()}this._applyFingerprint(event);event.breadcrumbs=tslib_1.__spread(event.breadcrumbs||[],this._breadcrumbs);event.breadcrumbs=0<event.breadcrumbs.length?event.breadcrumbs:void 0;return this._notifyEventProcessors(tslib_1.__spread(getGlobalEventProcessors(),this._eventProcessors),event,hint)};return Scope}();export{Scope};function getGlobalEventProcessors(){var global=getGlobalObject();global.__SENTRY__=global.__SENTRY__||{};global.__SENTRY__.globalEventProcessors=global.__SENTRY__.globalEventProcessors||[];return global.__SENTRY__.globalEventProcessors}export function addGlobalEventProcessor(callback){getGlobalEventProcessors().push(callback)}