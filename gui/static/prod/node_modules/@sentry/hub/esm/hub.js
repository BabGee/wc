import*as tslib_1 from"../../../tslib/tslib.es6.js";import{consoleSandbox,dynamicRequire,getGlobalObject,isNodeEnv,logger,timestampWithMs,uuid4}from"../../utils/esm/index.js";import{Scope}from"./scope.js";export var API_VERSION=3;var DEFAULT_BREADCRUMBS=30,MAX_BREADCRUMBS=100,Hub=function(){function Hub(client,scope,_version){if(void 0===scope){scope=new Scope}if(void 0===_version){_version=API_VERSION}this._version=_version;this._stack=[];this._stack.push({client:client,scope:scope})}Hub.prototype._invokeClient=function(method){for(var _a,args=[],_i=1;_i<arguments.length;_i++){args[_i-1]=arguments[_i]}var top=this.getStackTop();if(top&&top.client&&top.client[method]){(_a=top.client)[method].apply(_a,tslib_1.__spread(args,[top.scope]))}};Hub.prototype.isOlderThan=function(version){return this._version<version};Hub.prototype.bindClient=function(client){var top=this.getStackTop();top.client=client};Hub.prototype.pushScope=function(){var stack=this.getStack(),parentScope=0<stack.length?stack[stack.length-1].scope:void 0,scope=Scope.clone(parentScope);this.getStack().push({client:this.getClient(),scope:scope});return scope};Hub.prototype.popScope=function(){return this.getStack().pop()!==void 0};Hub.prototype.withScope=function(callback){var scope=this.pushScope();try{callback(scope)}finally{this.popScope()}};Hub.prototype.getClient=function(){return this.getStackTop().client};Hub.prototype.getScope=function(){return this.getStackTop().scope};Hub.prototype.getStack=function(){return this._stack};Hub.prototype.getStackTop=function(){return this._stack[this._stack.length-1]};Hub.prototype.captureException=function(exception,hint){var eventId=this._lastEventId=uuid4(),finalHint=hint;if(!hint){var syntheticException;try{throw new Error("Sentry syntheticException")}catch(exception){syntheticException=exception}finalHint={originalException:exception,syntheticException:syntheticException}}this._invokeClient("captureException",exception,tslib_1.__assign({},finalHint,{event_id:eventId}));return eventId};Hub.prototype.captureMessage=function(message,level,hint){var eventId=this._lastEventId=uuid4(),finalHint=hint;if(!hint){var syntheticException;try{throw new Error(message)}catch(exception){syntheticException=exception}finalHint={originalException:message,syntheticException:syntheticException}}this._invokeClient("captureMessage",message,level,tslib_1.__assign({},finalHint,{event_id:eventId}));return eventId};Hub.prototype.captureEvent=function(event,hint){var eventId=this._lastEventId=uuid4();this._invokeClient("captureEvent",event,tslib_1.__assign({},hint,{event_id:eventId}));return eventId};Hub.prototype.lastEventId=function(){return this._lastEventId};Hub.prototype.addBreadcrumb=function(breadcrumb,hint){var top=this.getStackTop();if(!top.scope||!top.client){return}var _a=top.client.getOptions&&top.client.getOptions()||{},_b=_a.beforeBreadcrumb,beforeBreadcrumb=void 0===_b?null:_b,_c=_a.maxBreadcrumbs,maxBreadcrumbs=void 0===_c?DEFAULT_BREADCRUMBS:_c;if(0>=maxBreadcrumbs){return}var timestamp=timestampWithMs(),mergedBreadcrumb=tslib_1.__assign({timestamp:timestamp},breadcrumb),finalBreadcrumb=beforeBreadcrumb?consoleSandbox(function(){return beforeBreadcrumb(mergedBreadcrumb,hint)}):mergedBreadcrumb;if(null===finalBreadcrumb){return}top.scope.addBreadcrumb(finalBreadcrumb,Math.min(maxBreadcrumbs,MAX_BREADCRUMBS))};Hub.prototype.setUser=function(user){var top=this.getStackTop();if(!top.scope){return}top.scope.setUser(user)};Hub.prototype.setTags=function(tags){var top=this.getStackTop();if(!top.scope){return}top.scope.setTags(tags)};Hub.prototype.setExtras=function(extras){var top=this.getStackTop();if(!top.scope){return}top.scope.setExtras(extras)};Hub.prototype.setTag=function(key,value){var top=this.getStackTop();if(!top.scope){return}top.scope.setTag(key,value)};Hub.prototype.setExtra=function(key,extra){var top=this.getStackTop();if(!top.scope){return}top.scope.setExtra(key,extra)};Hub.prototype.setContext=function(name,context){var top=this.getStackTop();if(!top.scope){return}top.scope.setContext(name,context)};Hub.prototype.configureScope=function(callback){var top=this.getStackTop();if(top.scope&&top.client){callback(top.scope)}};Hub.prototype.run=function(callback){var oldHub=makeMain(this);try{callback(this)}finally{makeMain(oldHub)}};Hub.prototype.getIntegration=function(integration){var client=this.getClient();if(!client){return null}try{return client.getIntegration(integration)}catch(_oO){logger.warn("Cannot retrieve integration "+integration.id+" from the current Hub");return null}};Hub.prototype.startSpan=function(spanOrSpanContext,forceNoChild){if(void 0===forceNoChild){forceNoChild=!1}return this._callExtensionMethod("startSpan",spanOrSpanContext,forceNoChild)};Hub.prototype.traceHeaders=function(){return this._callExtensionMethod("traceHeaders")};Hub.prototype._callExtensionMethod=function(method){for(var args=[],_i=1;_i<arguments.length;_i++){args[_i-1]=arguments[_i]}var carrier=getMainCarrier(),sentry=carrier.__SENTRY__;if(sentry&&sentry.extensions&&"function"===typeof sentry.extensions[method]){return sentry.extensions[method].apply(this,args)}logger.warn("Extension method "+method+" couldn't be found, doing nothing.")};return Hub}();export{Hub};export function getMainCarrier(){var carrier=getGlobalObject();carrier.__SENTRY__=carrier.__SENTRY__||{extensions:{},hub:void 0};return carrier}export function makeMain(hub){var registry=getMainCarrier(),oldHub=getHubFromCarrier(registry);setHubOnCarrier(registry,hub);return oldHub}export function getCurrentHub(){var registry=getMainCarrier();if(!hasHubOnCarrier(registry)||getHubFromCarrier(registry).isOlderThan(API_VERSION)){setHubOnCarrier(registry,new Hub)}if(isNodeEnv()){return getHubFromActiveDomain(registry)}return getHubFromCarrier(registry)}function getHubFromActiveDomain(registry){try{var domain=dynamicRequire(module,"domain"),activeDomain=domain.active;if(!activeDomain){return getHubFromCarrier(registry)}if(!hasHubOnCarrier(activeDomain)||getHubFromCarrier(activeDomain).isOlderThan(API_VERSION)){var registryHubTopStack=getHubFromCarrier(registry).getStackTop();setHubOnCarrier(activeDomain,new Hub(registryHubTopStack.client,Scope.clone(registryHubTopStack.scope)))}return getHubFromCarrier(activeDomain)}catch(_Oo){return getHubFromCarrier(registry)}}function hasHubOnCarrier(carrier){if(carrier&&carrier.__SENTRY__&&carrier.__SENTRY__.hub){return!0}return!1}export function getHubFromCarrier(carrier){if(carrier&&carrier.__SENTRY__&&carrier.__SENTRY__.hub){return carrier.__SENTRY__.hub}carrier.__SENTRY__=carrier.__SENTRY__||{};carrier.__SENTRY__.hub=new Hub;return carrier.__SENTRY__.hub}export function setHubOnCarrier(carrier,hub){if(!carrier){return!1}carrier.__SENTRY__=carrier.__SENTRY__||{};carrier.__SENTRY__.hub=hub;return!0}