import{isElement,isError,isEvent,isInstanceOf,isPrimitive,isSyntheticEvent}from"./is.js";import{Memo}from"./memo.js";import{getFunctionName,htmlTreeAsString}from"./misc.js";import{truncate}from"./string.js";export function fill(source,name,replacement){if(!(name in source)){return}var original=source[name],wrapped=replacement(original);if("function"===typeof wrapped){try{wrapped.prototype=wrapped.prototype||{};Object.defineProperties(wrapped,{__sentry_original__:{enumerable:!1,value:original}})}catch(_Oo){}}source[name]=wrapped}export function urlEncode(object){return Object.keys(object).map(function(key){return encodeURIComponent(key)+"="+encodeURIComponent(object[key])}).join("&")}function getWalkSource(value){if(isError(value)){var error=value,err={message:error.message,name:error.name,stack:error.stack};for(var i in error){if(Object.prototype.hasOwnProperty.call(error,i)){err[i]=error[i]}}return err}if(isEvent(value)){var event_1=value,source={};source.type=event_1.type;try{source.target=isElement(event_1.target)?htmlTreeAsString(event_1.target):Object.prototype.toString.call(event_1.target)}catch(_oO){source.target="<unknown>"}try{source.currentTarget=isElement(event_1.currentTarget)?htmlTreeAsString(event_1.currentTarget):Object.prototype.toString.call(event_1.currentTarget)}catch(_oO){source.currentTarget="<unknown>"}if("undefined"!==typeof CustomEvent&&isInstanceOf(value,CustomEvent)){source.detail=event_1.detail}for(var i in event_1){if(Object.prototype.hasOwnProperty.call(event_1,i)){source[i]=event_1}}return source}return value}function utf8Length(value){return~-encodeURI(value).split(/%..|./).length}function jsonSize(value){return utf8Length(JSON.stringify(value))}export function normalizeToSize(object,depth,maxSize){if(void 0===depth){depth=3}if(void 0===maxSize){maxSize=1024*100}var serialized=normalize(object,depth);if(jsonSize(serialized)>maxSize){return normalizeToSize(object,depth-1,maxSize)}return serialized}function serializeValue(value){var type=Object.prototype.toString.call(value);if("string"===typeof value){return value}if("[object Object]"===type){return"[Object]"}if("[object Array]"===type){return"[Array]"}var normalized=normalizeValue(value);return isPrimitive(normalized)?normalized:type}function normalizeValue(value,key){if("domain"===key&&value&&"object"===typeof value&&value._events){return"[Domain]"}if("domainEmitter"===key){return"[DomainEmitter]"}if("undefined"!==typeof global&&value===global){return"[Global]"}if("undefined"!==typeof window&&value===window){return"[Window]"}if("undefined"!==typeof document&&value===document){return"[Document]"}if(isSyntheticEvent(value)){return"[SyntheticEvent]"}if("number"===typeof value&&value!==value){return"[NaN]"}if(void 0===value){return"[undefined]"}if("function"===typeof value){return"[Function: "+getFunctionName(value)+"]"}return value}export function walk(key,value,depth,memo){if(void 0===depth){depth=+Infinity}if(void 0===memo){memo=new Memo}if(0===depth){return serializeValue(value)}if(null!==value&&value!==void 0&&"function"===typeof value.toJSON){return value.toJSON()}var normalized=normalizeValue(value,key);if(isPrimitive(normalized)){return normalized}var source=getWalkSource(value),acc=Array.isArray(value)?[]:{};if(memo.memoize(value)){return"[Circular ~]"}for(var innerKey in source){if(!Object.prototype.hasOwnProperty.call(source,innerKey)){continue}acc[innerKey]=walk(innerKey,source[innerKey],depth-1,memo)}memo.unmemoize(value);return acc}export function normalize(input,depth){try{return JSON.parse(JSON.stringify(input,function(key,value){return walk(key,value,depth)}))}catch(_oO){return"**non-serializable**"}}export function extractExceptionKeysForMessage(exception,maxLength){if(void 0===maxLength){maxLength=40}var keys=Object.keys(getWalkSource(exception));keys.sort();if(!keys.length){return"[object has no keys]"}if(keys[0].length>=maxLength){return truncate(keys[0],maxLength)}for(var includedKeys=keys.length,serialized;0<includedKeys;includedKeys--){serialized=keys.slice(0,includedKeys).join(", ");if(serialized.length>maxLength){continue}if(includedKeys===keys.length){return serialized}return truncate(serialized,maxLength)}return""}