import*as tslib_1 from"../../../tslib/tslib.es6.js";import{isInstanceOf,isString}from"./is.js";import{logger}from"./logger.js";import{getFunctionName,getGlobalObject}from"./misc.js";import{fill}from"./object.js";import{supportsHistory,supportsNativeFetch}from"./supports.js";var global=getGlobalObject(),handlers={},instrumented={};function instrument(type){if(instrumented[type]){return}instrumented[type]=!0;switch(type){case"console":instrumentConsole();break;case"dom":instrumentDOM();break;case"xhr":instrumentXHR();break;case"fetch":instrumentFetch();break;case"history":instrumentHistory();break;default:logger.warn("unknown instrumentation type:",type);}}export function addInstrumentationHandler(handler){if(!handler||"string"!==typeof handler.type||"function"!==typeof handler.callback){return}handlers[handler.type]=handlers[handler.type]||[];handlers[handler.type].push(handler.callback);instrument(handler.type)}function triggerHandlers(type,data){var e_1,_a;if(!type||!handlers[type]){return}try{for(var _b=tslib_1.__values(handlers[type]||[]),_c=_b.next(),handler;!_c.done;_c=_b.next()){handler=_c.value;try{handler(data)}catch(e){logger.error("Error while triggering instrumentation handler.\nType: "+type+"\nName: "+getFunctionName(handler)+"\nError: "+e)}}}catch(e_1_1){e_1={error:e_1_1}}finally{try{if(_c&&!_c.done&&(_a=_b.return))_a.call(_b)}finally{if(e_1)throw e_1.error}}}function instrumentConsole(){if(!("console"in global)){return}["debug","info","warn","error","log","assert"].forEach(function(level){if(!(level in global.console)){return}fill(global.console,level,function(originalConsoleLevel){return function(){for(var args=[],_i=0;_i<arguments.length;_i++){args[_i]=arguments[_i]}triggerHandlers("console",{args:args,level:level});if(originalConsoleLevel){Function.prototype.apply.call(originalConsoleLevel,global.console,args)}}})})}function instrumentFetch(){if(!supportsNativeFetch()){return}fill(global,"fetch",function(originalFetch){return function(){for(var args=[],_i=0;_i<arguments.length;_i++){args[_i]=arguments[_i]}var commonHandlerData={args:args,fetchData:{method:getFetchMethod(args),url:getFetchUrl(args)},startTimestamp:Date.now()};triggerHandlers("fetch",tslib_1.__assign({},commonHandlerData));return originalFetch.apply(global,args).then(function(response){triggerHandlers("fetch",tslib_1.__assign({},commonHandlerData,{endTimestamp:Date.now(),response:response}));return response},function(error){triggerHandlers("fetch",tslib_1.__assign({},commonHandlerData,{endTimestamp:Date.now(),error:error}));throw error})}})}function getFetchMethod(fetchArgs){if(void 0===fetchArgs){fetchArgs=[]}if("Request"in global&&isInstanceOf(fetchArgs[0],Request)&&fetchArgs[0].method){return(fetchArgs[0].method+"").toUpperCase()}if(fetchArgs[1]&&fetchArgs[1].method){return(fetchArgs[1].method+"").toUpperCase()}return"GET"}function getFetchUrl(fetchArgs){if(void 0===fetchArgs){fetchArgs=[]}if("string"===typeof fetchArgs[0]){return fetchArgs[0]}if("Request"in global&&isInstanceOf(fetchArgs[0],Request)){return fetchArgs[0].url}return fetchArgs[0]+""}function instrumentXHR(){if(!("XMLHttpRequest"in global)){return}var xhrproto=XMLHttpRequest.prototype;fill(xhrproto,"open",function(originalOpen){return function(){for(var args=[],_i=0;_i<arguments.length;_i++){args[_i]=arguments[_i]}var url=args[1];this.__sentry_xhr__={method:isString(args[0])?args[0].toUpperCase():args[0],url:args[1]};if(isString(url)&&"POST"===this.__sentry_xhr__.method&&url.match(/sentry_key/)){this.__sentry_own_request__=!0}return originalOpen.apply(this,args)}});fill(xhrproto,"send",function(originalSend){return function(){for(var args=[],_i=0;_i<arguments.length;_i++){args[_i]=arguments[_i]}var xhr=this,commonHandlerData={args:args,startTimestamp:Date.now(),xhr:xhr};triggerHandlers("xhr",tslib_1.__assign({},commonHandlerData));function onreadystatechangeHandler(){if(4===xhr.readyState){try{if(xhr.__sentry_xhr__){xhr.__sentry_xhr__.status_code=xhr.status}}catch(e){}triggerHandlers("xhr",tslib_1.__assign({},commonHandlerData,{endTimestamp:Date.now()}))}}if("onreadystatechange"in xhr&&"function"===typeof xhr.onreadystatechange){fill(xhr,"onreadystatechange",function(original){return function(){for(var readyStateArgs=[],_i=0;_i<arguments.length;_i++){readyStateArgs[_i]=arguments[_i]}onreadystatechangeHandler();return original.apply(xhr,readyStateArgs)}})}else{xhr.onreadystatechange=onreadystatechangeHandler}return originalSend.apply(this,args)}})}var lastHref;function instrumentHistory(){if(!supportsHistory()){return}var oldOnPopState=global.onpopstate;global.onpopstate=function(){for(var args=[],_i=0;_i<arguments.length;_i++){args[_i]=arguments[_i]}var to=global.location.href,from=lastHref;lastHref=to;triggerHandlers("history",{from:from,to:to});if(oldOnPopState){return oldOnPopState.apply(this,args)}};function historyReplacementFunction(originalHistoryFunction){return function(){for(var args=[],_i=0;_i<arguments.length;_i++){args[_i]=arguments[_i]}var url=2<args.length?args[2]:void 0;if(url){var from=lastHref,to=url+"";lastHref=to;triggerHandlers("history",{from:from,to:to})}return originalHistoryFunction.apply(this,args)}}fill(global.history,"pushState",historyReplacementFunction);fill(global.history,"replaceState",historyReplacementFunction)}function instrumentDOM(){if(!("document"in global)){return}global.document.addEventListener("click",domEventHandler("click",triggerHandlers.bind(null,"dom")),!1);global.document.addEventListener("keypress",keypressEventHandler(triggerHandlers.bind(null,"dom")),!1);["EventTarget","Node"].forEach(function(target){var proto=global[target]&&global[target].prototype;if(!proto||!proto.hasOwnProperty||!proto.hasOwnProperty("addEventListener")){return}fill(proto,"addEventListener",function(original){return function(eventName,fn,options){if(fn&&fn.handleEvent){if("click"===eventName){fill(fn,"handleEvent",function(innerOriginal){return function(event){domEventHandler("click",triggerHandlers.bind(null,"dom"))(event);return innerOriginal.call(this,event)}})}if("keypress"===eventName){fill(fn,"handleEvent",function(innerOriginal){return function(event){keypressEventHandler(triggerHandlers.bind(null,"dom"))(event);return innerOriginal.call(this,event)}})}}else{if("click"===eventName){domEventHandler("click",triggerHandlers.bind(null,"dom"),!0)(this)}if("keypress"===eventName){keypressEventHandler(triggerHandlers.bind(null,"dom"))(this)}}return original.call(this,eventName,fn,options)}});fill(proto,"removeEventListener",function(original){return function(eventName,fn,options){var callback=fn;try{callback=callback&&(callback.__sentry_wrapped__||callback)}catch(e){}return original.call(this,eventName,callback,options)}})})}var debounceDuration=1e3,debounceTimer=0,keypressTimeout,lastCapturedEvent;function domEventHandler(name,handler,debounce){if(void 0===debounce){debounce=!1}return function(event){keypressTimeout=void 0;if(!event||lastCapturedEvent===event){return}lastCapturedEvent=event;if(debounceTimer){clearTimeout(debounceTimer)}if(debounce){debounceTimer=setTimeout(function(){handler({event:event,name:name})})}else{handler({event:event,name:name})}}}function keypressEventHandler(handler){return function(event){var target;try{target=event.target}catch(e){return}var tagName=target&&target.tagName;if(!tagName||"INPUT"!==tagName&&"TEXTAREA"!==tagName&&!target.isContentEditable){return}if(!keypressTimeout){domEventHandler("input",handler)(event)}clearTimeout(keypressTimeout);keypressTimeout=setTimeout(function(){keypressTimeout=void 0},debounceDuration)}}