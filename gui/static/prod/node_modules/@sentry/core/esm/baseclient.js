import*as tslib_1 from"../../../tslib/tslib.es6.js";import{Dsn,isPrimitive,isThenable,logger,SyncPromise,truncate,uuid4}from"../../utils/esm/index.js";import{setupIntegrations}from"./integration.js";var BaseClient=function(){function BaseClient(backendClass,options){this._integrations={};this._processing=!1;this._backend=new backendClass(options);this._options=options;if(options.dsn){this._dsn=new Dsn(options.dsn)}if(this._isEnabled()){this._integrations=setupIntegrations(this._options)}}BaseClient.prototype.captureException=function(exception,hint,scope){var _this=this,eventId=hint&&hint.event_id;this._processing=!0;this._getBackend().eventFromException(exception,hint).then(function(event){return _this._processEvent(event,hint,scope)}).then(function(finalEvent){eventId=finalEvent&&finalEvent.event_id;_this._processing=!1}).then(null,function(reason){logger.error(reason);_this._processing=!1});return eventId};BaseClient.prototype.captureMessage=function(message,level,hint,scope){var _this=this,eventId=hint&&hint.event_id;this._processing=!0;var promisedEvent=isPrimitive(message)?this._getBackend().eventFromMessage(""+message,level,hint):this._getBackend().eventFromException(message,hint);promisedEvent.then(function(event){return _this._processEvent(event,hint,scope)}).then(function(finalEvent){eventId=finalEvent&&finalEvent.event_id;_this._processing=!1}).then(null,function(reason){logger.error(reason);_this._processing=!1});return eventId};BaseClient.prototype.captureEvent=function(event,hint,scope){var _this=this,eventId=hint&&hint.event_id;this._processing=!0;this._processEvent(event,hint,scope).then(function(finalEvent){eventId=finalEvent&&finalEvent.event_id;_this._processing=!1}).then(null,function(reason){logger.error(reason);_this._processing=!1});return eventId};BaseClient.prototype.getDsn=function(){return this._dsn};BaseClient.prototype.getOptions=function(){return this._options};BaseClient.prototype.flush=function(timeout){var _this=this;return this._isClientProcessing(timeout).then(function(status){clearInterval(status.interval);return _this._getBackend().getTransport().close(timeout).then(function(transportFlushed){return status.ready&&transportFlushed})})};BaseClient.prototype.close=function(timeout){var _this=this;return this.flush(timeout).then(function(result){_this.getOptions().enabled=!1;return result})};BaseClient.prototype.getIntegrations=function(){return this._integrations||{}};BaseClient.prototype.getIntegration=function(integration){try{return this._integrations[integration.id]||null}catch(_oO){logger.warn("Cannot retrieve integration "+integration.id+" from the current Client");return null}};BaseClient.prototype._isClientProcessing=function(timeout){var _this=this;return new SyncPromise(function(resolve){var ticked=0,tick=1,interval=0;clearInterval(interval);interval=setInterval(function(){if(!_this._processing){resolve({interval:interval,ready:!0})}else{ticked+=tick;if(timeout&&ticked>=timeout){resolve({interval:interval,ready:!1})}}},tick)})};BaseClient.prototype._getBackend=function(){return this._backend};BaseClient.prototype._isEnabled=function(){return!1!==this.getOptions().enabled&&this._dsn!==void 0};BaseClient.prototype._prepareEvent=function(event,scope,hint){var _a=this.getOptions(),environment=_a.environment,release=_a.release,dist=_a.dist,_b=_a.maxValueLength,maxValueLength=void 0===_b?250:_b,prepared=tslib_1.__assign({},event);if(prepared.environment===void 0&&environment!==void 0){prepared.environment=environment}if(prepared.release===void 0&&release!==void 0){prepared.release=release}if(prepared.dist===void 0&&dist!==void 0){prepared.dist=dist}if(prepared.message){prepared.message=truncate(prepared.message,maxValueLength)}var exception=prepared.exception&&prepared.exception.values&&prepared.exception.values[0];if(exception&&exception.value){exception.value=truncate(exception.value,maxValueLength)}var request=prepared.request;if(request&&request.url){request.url=truncate(request.url,maxValueLength)}if(prepared.event_id===void 0){prepared.event_id=uuid4()}this._addIntegrations(prepared.sdk);var result=SyncPromise.resolve(prepared);if(scope){result=scope.applyToEvent(prepared,hint)}return result};BaseClient.prototype._addIntegrations=function(sdkInfo){var integrationsArray=Object.keys(this._integrations);if(sdkInfo&&0<integrationsArray.length){sdkInfo.integrations=integrationsArray}};BaseClient.prototype._processEvent=function(event,hint,scope){var _this=this,_a=this.getOptions(),beforeSend=_a.beforeSend,sampleRate=_a.sampleRate;if(!this._isEnabled()){return SyncPromise.reject("SDK not enabled, will not send event.")}if("number"===typeof sampleRate&&Math.random()>sampleRate){return SyncPromise.reject("This event has been sampled, will not send event.")}return new SyncPromise(function(resolve,reject){_this._prepareEvent(event,scope,hint).then(function(prepared){if(null===prepared){reject("An event processor returned null, will not send event.");return}var finalEvent=prepared;try{var isInternalException=hint&&hint.data&&!0===hint.data.__sentry__;if(isInternalException||!beforeSend){_this._getBackend().sendEvent(finalEvent);resolve(finalEvent);return}var beforeSendResult=beforeSend(prepared,hint);if("undefined"===typeof beforeSendResult){logger.error("`beforeSend` method has to return `null` or a valid event.")}else if(isThenable(beforeSendResult)){_this._handleAsyncBeforeSend(beforeSendResult,resolve,reject)}else{finalEvent=beforeSendResult;if(null===finalEvent){logger.log("`beforeSend` returned `null`, will not send event.");resolve(null);return}_this._getBackend().sendEvent(finalEvent);resolve(finalEvent)}}catch(exception){_this.captureException(exception,{data:{__sentry__:!0},originalException:exception});reject("`beforeSend` threw an error, will not send event.")}}).then(null,function(){reject("`beforeSend` threw an error, will not send event.")})})};BaseClient.prototype._handleAsyncBeforeSend=function(beforeSend,resolve,reject){var _this=this;beforeSend.then(function(processedEvent){if(null===processedEvent){reject("`beforeSend` returned `null`, will not send event.");return}_this._getBackend().sendEvent(processedEvent);resolve(processedEvent)}).then(null,function(e){reject("beforeSend rejected with "+e)})};return BaseClient}();export{BaseClient};