import*as tslib_1 from"../../../../tslib/tslib.es6.js";import{API,getCurrentHub}from"../../../core/esm/index.js";import{Severity}from"../../../types/esm/index.js";import{addInstrumentationHandler,getEventDescription,getGlobalObject,htmlTreeAsString,logger,normalize,parseUrl,safeJoin}from"../../../utils/esm/index.js";var Breadcrumbs=function(){function Breadcrumbs(options){this.name=Breadcrumbs.id;this._options=tslib_1.__assign({console:!0,dom:!0,fetch:!0,history:!0,sentry:!0,xhr:!0},options)}Breadcrumbs.prototype._consoleBreadcrumb=function(handlerData){var breadcrumb={category:"console",data:{extra:{arguments:normalize(handlerData.args,3)},logger:"console"},level:Severity.fromString(handlerData.level),message:safeJoin(handlerData.args," ")};if("assert"===handlerData.level){if(!1===handlerData.args[0]){breadcrumb.message="Assertion failed: "+(safeJoin(handlerData.args.slice(1)," ")||"console.assert");breadcrumb.data.extra.arguments=normalize(handlerData.args.slice(1),3)}else{return}}getCurrentHub().addBreadcrumb(breadcrumb,{input:handlerData.args,level:handlerData.level})};Breadcrumbs.prototype._domBreadcrumb=function(handlerData){var target;try{target=handlerData.event.target?htmlTreeAsString(handlerData.event.target):htmlTreeAsString(handlerData.event)}catch(e){target="<unknown>"}if(0===target.length){return}getCurrentHub().addBreadcrumb({category:"ui."+handlerData.name,message:target},{event:event,name:handlerData.name})};Breadcrumbs.prototype._xhrBreadcrumb=function(handlerData){if(handlerData.endTimestamp){if(handlerData.xhr.__sentry_own_request__){return}getCurrentHub().addBreadcrumb({category:"xhr",data:handlerData.xhr.__sentry_xhr__,type:"http"},{xhr:handlerData.xhr});return}if(handlerData.xhr.__sentry_own_request__){addSentryBreadcrumb(handlerData.args[0])}};Breadcrumbs.prototype._fetchBreadcrumb=function(handlerData){if(!handlerData.endTimestamp){return}var client=getCurrentHub().getClient(),dsn=client&&client.getDsn();if(dsn){var filterUrl=new API(dsn).getStoreEndpoint();if(filterUrl&&-1!==handlerData.fetchData.url.indexOf(filterUrl)&&"POST"===handlerData.fetchData.method&&handlerData.args[1]&&handlerData.args[1].body){addSentryBreadcrumb(handlerData.args[1].body);return}}if(handlerData.error){getCurrentHub().addBreadcrumb({category:"fetch",data:tslib_1.__assign({},handlerData.fetchData,{status_code:handlerData.response.status}),level:Severity.Error,type:"http"},{data:handlerData.error,input:handlerData.args})}else{getCurrentHub().addBreadcrumb({category:"fetch",data:tslib_1.__assign({},handlerData.fetchData,{status_code:handlerData.response.status}),type:"http"},{input:handlerData.args,response:handlerData.response})}};Breadcrumbs.prototype._historyBreadcrumb=function(handlerData){var global=getGlobalObject(),from=handlerData.from,to=handlerData.to,parsedLoc=parseUrl(global.location.href),parsedFrom=parseUrl(from),parsedTo=parseUrl(to);if(!parsedFrom.path){parsedFrom=parsedLoc}if(parsedLoc.protocol===parsedTo.protocol&&parsedLoc.host===parsedTo.host){to=parsedTo.relative}if(parsedLoc.protocol===parsedFrom.protocol&&parsedLoc.host===parsedFrom.host){from=parsedFrom.relative}getCurrentHub().addBreadcrumb({category:"navigation",data:{from:from,to:to}})};Breadcrumbs.prototype.setupOnce=function(){var _this=this;if(this._options.console){addInstrumentationHandler({callback:function(){for(var args=[],_i=0;_i<arguments.length;_i++){args[_i]=arguments[_i]}_this._consoleBreadcrumb.apply(_this,tslib_1.__spread(args))},type:"console"})}if(this._options.dom){addInstrumentationHandler({callback:function(){for(var args=[],_i=0;_i<arguments.length;_i++){args[_i]=arguments[_i]}_this._domBreadcrumb.apply(_this,tslib_1.__spread(args))},type:"dom"})}if(this._options.xhr){addInstrumentationHandler({callback:function(){for(var args=[],_i=0;_i<arguments.length;_i++){args[_i]=arguments[_i]}_this._xhrBreadcrumb.apply(_this,tslib_1.__spread(args))},type:"xhr"})}if(this._options.fetch){addInstrumentationHandler({callback:function(){for(var args=[],_i=0;_i<arguments.length;_i++){args[_i]=arguments[_i]}_this._fetchBreadcrumb.apply(_this,tslib_1.__spread(args))},type:"fetch"})}if(this._options.history){addInstrumentationHandler({callback:function(){for(var args=[],_i=0;_i<arguments.length;_i++){args[_i]=arguments[_i]}_this._historyBreadcrumb.apply(_this,tslib_1.__spread(args))},type:"history"})}};Breadcrumbs.id="Breadcrumbs";return Breadcrumbs}();export{Breadcrumbs};function addSentryBreadcrumb(serializedData){try{var event_1=JSON.parse(serializedData);getCurrentHub().addBreadcrumb({category:"sentry",event_id:event_1.event_id,level:event_1.level||Severity.fromString("error"),message:getEventDescription(event_1)},{event:event_1})}catch(_oO){logger.error("Error while adding sentry type breadcrumb")}}