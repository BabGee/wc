import*as tslib_1 from"../../../../tslib/tslib.es6.js";import{getCurrentHub}from"../../../core/esm/index.js";import{Severity}from"../../../types/esm/index.js";import{addExceptionMechanism,getGlobalObject,getLocationHref,isErrorEvent,isPrimitive,isString,logger}from"../../../utils/esm/index.js";import{eventFromUnknownInput}from"../eventbuilder.js";import{shouldIgnoreOnError}from"../helpers.js";var GlobalHandlers=function(){function GlobalHandlers(options){this.name=GlobalHandlers.id;this._global=getGlobalObject();this._oldOnErrorHandler=null;this._oldOnUnhandledRejectionHandler=null;this._onErrorHandlerInstalled=!1;this._onUnhandledRejectionHandlerInstalled=!1;this._options=tslib_1.__assign({onerror:!0,onunhandledrejection:!0},options)}GlobalHandlers.prototype.setupOnce=function(){Error.stackTraceLimit=50;if(this._options.onerror){logger.log("Global Handler attached: onerror");this._installGlobalOnErrorHandler()}if(this._options.onunhandledrejection){logger.log("Global Handler attached: onunhandledrejection");this._installGlobalOnUnhandledRejectionHandler()}};GlobalHandlers.prototype._installGlobalOnErrorHandler=function(){if(this._onErrorHandlerInstalled){return}var self=this;this._oldOnErrorHandler=this._global.onerror;this._global.onerror=function(msg,url,line,column,error){var currentHub=getCurrentHub(),hasIntegration=currentHub.getIntegration(GlobalHandlers),isFailedOwnDelivery=error&&!0===error.__sentry_own_request__;if(!hasIntegration||shouldIgnoreOnError()||isFailedOwnDelivery){if(self._oldOnErrorHandler){return self._oldOnErrorHandler.apply(this,arguments)}return!0}var client=currentHub.getClient(),event=isPrimitive(error)?self._eventFromIncompleteOnError(msg,url,line,column):self._enhanceEventWithInitialFrame(eventFromUnknownInput(error,void 0,{attachStacktrace:client&&client.getOptions().attachStacktrace,rejection:!1}),url,line,column);addExceptionMechanism(event,{handled:!1,type:"onerror"});currentHub.captureEvent(event,{originalException:error});if(self._oldOnErrorHandler){return self._oldOnErrorHandler.apply(this,arguments)}return!0};this._onErrorHandlerInstalled=!0};GlobalHandlers.prototype._installGlobalOnUnhandledRejectionHandler=function(){if(this._onUnhandledRejectionHandlerInstalled){return}var self=this;this._oldOnUnhandledRejectionHandler=this._global.onunhandledrejection;this._global.onunhandledrejection=function(e){var error=e;try{error=e&&"reason"in e?e.reason:e}catch(_oO){}var currentHub=getCurrentHub(),hasIntegration=currentHub.getIntegration(GlobalHandlers),isFailedOwnDelivery=error&&!0===error.__sentry_own_request__;if(!hasIntegration||shouldIgnoreOnError()||isFailedOwnDelivery){if(self._oldOnUnhandledRejectionHandler){return self._oldOnUnhandledRejectionHandler.apply(this,arguments)}return!0}var client=currentHub.getClient(),event=isPrimitive(error)?self._eventFromIncompleteRejection(error):eventFromUnknownInput(error,void 0,{attachStacktrace:client&&client.getOptions().attachStacktrace,rejection:!0});event.level=Severity.Error;addExceptionMechanism(event,{handled:!1,type:"onunhandledrejection"});currentHub.captureEvent(event,{originalException:error});if(self._oldOnUnhandledRejectionHandler){return self._oldOnUnhandledRejectionHandler.apply(this,arguments)}return!0};this._onUnhandledRejectionHandlerInstalled=!0};GlobalHandlers.prototype._eventFromIncompleteOnError=function(msg,url,line,column){var ERROR_TYPES_RE=/^(?:[Uu]ncaught (?:exception: )?)?(?:((?:Eval|Internal|Range|Reference|Syntax|Type|URI|)Error): )?(.*)$/i,message=isErrorEvent(msg)?msg.message:msg,name;if(isString(message)){var groups=message.match(ERROR_TYPES_RE);if(groups){name=groups[1];message=groups[2]}}var event={exception:{values:[{type:name||"Error",value:message}]}};return this._enhanceEventWithInitialFrame(event,url,line,column)};GlobalHandlers.prototype._eventFromIncompleteRejection=function(error){return{exception:{values:[{type:"UnhandledRejection",value:"Non-Error promise rejection captured with value: "+error}]}}};GlobalHandlers.prototype._enhanceEventWithInitialFrame=function(event,url,line,column){event.exception=event.exception||{};event.exception.values=event.exception.values||[];event.exception.values[0]=event.exception.values[0]||{};event.exception.values[0].stacktrace=event.exception.values[0].stacktrace||{};event.exception.values[0].stacktrace.frames=event.exception.values[0].stacktrace.frames||[];var colno=isNaN(parseInt(column,10))?void 0:column,lineno=isNaN(parseInt(line,10))?void 0:line,filename=isString(url)&&0<url.length?url:getLocationHref();if(0===event.exception.values[0].stacktrace.frames.length){event.exception.values[0].stacktrace.frames.push({colno:colno,filename:filename,function:"?",in_app:!0,lineno:lineno})}return event};GlobalHandlers.id="GlobalHandlers";return GlobalHandlers}();export{GlobalHandlers};