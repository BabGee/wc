import defaultLocale from"../locale/en-US/index.js";import subMilliseconds from"../subMilliseconds/index.js";import toDate from"../toDate/index.js";import assign from"../_lib/assign/index.js";import longFormatters from"../_lib/format/longFormatters/index.js";import getTimezoneOffsetInMilliseconds from"../_lib/getTimezoneOffsetInMilliseconds/index.js";import{isProtectedDayOfYearToken,isProtectedWeekYearToken,throwProtectedError}from"../_lib/protectedTokens/index.js";import toInteger from"../_lib/toInteger/index.js";import parsers from"./_lib/parsers/index.js";var TIMEZONE_UNIT_PRIORITY=10,formattingTokensRegExp=/[yYQqMLwIdDecihHKkms]o|(\w)\1*|''|'(''|[^'])+('|$)|./g,longFormattingTokensRegExp=/P+p+|P+|p+|''|'(''|[^'])+('|$)|./g,escapedStringRegExp=/^'(.*?)'?$/,doubleQuoteRegExp=/''/g,notWhitespaceRegExp=/\S/,unescapedLatinCharacterRegExp=/[a-zA-Z]/;export default function parse(dirtyDateString,dirtyFormatString,dirtyBackupDate,dirtyOptions){if(3>arguments.length){throw new TypeError("3 arguments required, but only "+arguments.length+" present")}var dateString=dirtyDateString+"",formatString=dirtyFormatString+"",options=dirtyOptions||{},locale=options.locale||defaultLocale;if(!locale.match){throw new RangeError("locale must contain match property")}var localeFirstWeekContainsDate=locale.options&&locale.options.firstWeekContainsDate,defaultFirstWeekContainsDate=null==localeFirstWeekContainsDate?1:toInteger(localeFirstWeekContainsDate),firstWeekContainsDate=null==options.firstWeekContainsDate?defaultFirstWeekContainsDate:toInteger(options.firstWeekContainsDate);if(!(1<=firstWeekContainsDate&&7>=firstWeekContainsDate)){throw new RangeError("firstWeekContainsDate must be between 1 and 7 inclusively")}var localeWeekStartsOn=locale.options&&locale.options.weekStartsOn,defaultWeekStartsOn=null==localeWeekStartsOn?0:toInteger(localeWeekStartsOn),weekStartsOn=null==options.weekStartsOn?defaultWeekStartsOn:toInteger(options.weekStartsOn);if(!(0<=weekStartsOn&&6>=weekStartsOn)){throw new RangeError("weekStartsOn must be between 0 and 6 inclusively")}if(""===formatString){if(""===dateString){return toDate(dirtyBackupDate)}else{return new Date(NaN)}}var subFnOptions={firstWeekContainsDate:firstWeekContainsDate,weekStartsOn:weekStartsOn,locale:locale},setters=[{priority:TIMEZONE_UNIT_PRIORITY,set:dateToSystemTimezone,index:0}],i,tokens=formatString.match(longFormattingTokensRegExp).map(function(substring){var firstCharacter=substring[0];if("p"===firstCharacter||"P"===firstCharacter){var longFormatter=longFormatters[firstCharacter];return longFormatter(substring,locale.formatLong,subFnOptions)}return substring}).join("").match(formattingTokensRegExp),usedTokens=[];for(i=0;i<tokens.length;i++){var token=tokens[i];if(!options.useAdditionalWeekYearTokens&&isProtectedWeekYearToken(token)){throwProtectedError(token)}if(!options.useAdditionalDayOfYearTokens&&isProtectedDayOfYearToken(token)){throwProtectedError(token)}var firstCharacter=token[0],parser=parsers[firstCharacter];if(parser){var incompatibleTokens=parser.incompatibleTokens;if(Array.isArray(incompatibleTokens)){for(var incompatibleToken=void 0,_i=0,usedToken;_i<usedTokens.length;_i++){usedToken=usedTokens[_i].token;if(-1!==incompatibleTokens.indexOf(usedToken)||usedToken===firstCharacter){incompatibleToken=usedTokens[_i];break}}if(incompatibleToken){throw new RangeError("The format string mustn't contain `".concat(incompatibleToken.fullToken,"` and `").concat(token,"` at the same time"))}}else if("*"===parser.incompatibleTokens&&usedTokens.length){throw new RangeError("The format string mustn't contain `".concat(token,"` and any other token at the same time"))}usedTokens.push({token:firstCharacter,fullToken:token});var parseResult=parser.parse(dateString,token,locale.match,subFnOptions);if(!parseResult){return new Date(NaN)}setters.push({priority:parser.priority,set:parser.set,validate:parser.validate,value:parseResult.value,index:setters.length});dateString=parseResult.rest}else{if(firstCharacter.match(unescapedLatinCharacterRegExp)){throw new RangeError("Format string contains an unescaped latin alphabet character `"+firstCharacter+"`")}if("''"===token){token="'"}else if("'"===firstCharacter){token=cleanEscapedString(token)}if(0===dateString.indexOf(token)){dateString=dateString.slice(token.length)}else{return new Date(NaN)}}}if(0<dateString.length&&notWhitespaceRegExp.test(dateString)){return new Date(NaN)}var uniquePrioritySetters=setters.map(function(setter){return setter.priority}).sort(function(a,b){return b-a}).filter(function(priority,index,array){return array.indexOf(priority)===index}).map(function(priority){return setters.filter(function(setter){return setter.priority===priority}).reverse()}).map(function(setterArray){return setterArray[0]}),date=toDate(dirtyBackupDate);if(isNaN(date)){return new Date(NaN)}var utcDate=subMilliseconds(date,getTimezoneOffsetInMilliseconds(date)),flags={};for(i=0;i<uniquePrioritySetters.length;i++){var setter=uniquePrioritySetters[i];if(setter.validate&&!setter.validate(utcDate,setter.value,subFnOptions)){return new Date(NaN)}var result=setter.set(utcDate,flags,setter.value,subFnOptions);if(result[0]){utcDate=result[0];assign(flags,result[1])}else{utcDate=result}}return utcDate}function dateToSystemTimezone(date,flags){if(flags.timestampIsSet){return date}var convertedDate=new Date(0);convertedDate.setFullYear(date.getUTCFullYear(),date.getUTCMonth(),date.getUTCDate());convertedDate.setHours(date.getUTCHours(),date.getUTCMinutes(),date.getUTCSeconds(),date.getUTCMilliseconds());return convertedDate}function cleanEscapedString(input){return input.match(escapedStringRegExp)[1].replace(doubleQuoteRegExp,"'")}