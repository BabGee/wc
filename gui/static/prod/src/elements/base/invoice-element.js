import{utilsMixin}from"../../core/mixins/utils-mixin.js";import{dataSourceMixin}from"../../core/mixins/datasource-mixin.js";import{BaseElement}from"../../core/base-element.js";import{format}from"../../../node_modules/date-fns/esm/index.js";import"../../../node_modules/jspdf/dist/jspdf.min.js";export const InvoiceElementBase=class extends utilsMixin(dataSourceMixin(BaseElement)){constructor(){super();const rP=document.querySelector("adaptive-ui")._payload;this.seller={name:rP.name,logo:rP.logo};this.buyer={name:rP.profile?rP.profile.firstName+" "+rP.profile.lastName:"Customer"};this.items=[]}static get is(){return"invoice-element"}static get properties(){return{items:Array,sums:Object,invoice:Number,reference:String,created:String,seller:Object,buyer:Object}}firstUpdated(changedProperties){super.firstUpdated(changedProperties);const self=this;this.loader.then(dsc=>{for(var sums={},data=[],i=0;i<dsc.rows.length;i++){for(var item={},itemLinks=[],j=0;j<dsc.cols.length;j++){if("cart_item__total"===dsc.cols[j].value){if(!sums[dsc.cols[j].value]){sums[dsc.cols[j].value]={name:dsc.cols[j].label,value:0}}sums[dsc.cols[j].value].value+=parseInt(dsc.rows[i][j])}if("href"===dsc.cols[j].type){var links=self.cols[j].links;for(var link in links){var linkObject=links[link],linkProcessed={};linkProcessed.service=linkObject.service;linkProcessed.icon=linkObject.icon;linkProcessed.params={};for(var linkParamKey in linkObject.params){var linkParam=linkObject.params[linkParamKey];linkProcessed.params[linkParamKey]=item[linkParam]}itemLinks.push(linkProcessed)}}else{item[dsc.cols[j].label]=dsc.rows[i][j]}}item.links=itemLinks;data.push(item)}self.items=data;self.sums=sums;if(self.items.length){self.created=format(new Date(self.items[0].created),"dd/MM/yyyy")}})}print(){this.printPdf(!0)}save(){this.printPdf(!1)}dscDataName(){return this.e.defaultValue}_getOverallTotal(sums){if(sums){return sums.cart_item__total.value}return 0}_getColumnTotal(column){if(this.sums){return this.sums[column].value}return 0}printPdf(autoPrint){const self=this;var doc=new jsPDF("p","mm","a3");let WIDTH=210;let X=0,Y=0;Y+=5;X+=60;const LINE_HEIGHT=7;Y+=20;doc.setFontType("bold");doc.text(X,Y,self.seller.name);doc.setFontType("normal");Y+=20;X=20;doc.setTextColor(0,0,255);doc.setFontSize(30);doc.text(X,Y,"INVOICE");doc.setFontSize(16);doc.setTextColor(31,8,34);const GAP=200;Y+=LINE_HEIGHT;doc.setFontType("bold");doc.text(X,Y,"BILL TO");doc.setFontType("normal");doc.text(X+GAP,Y,"INVOICE #"+self.invoice);Y+=LINE_HEIGHT;doc.text(X,Y,self.buyer.name);doc.text(X+GAP,Y,"DATE "+self.created);Y+=LINE_HEIGHT;doc.text(X+GAP,Y,"TERMS Due on receipt");Y+=LINE_HEIGHT;doc.text(X,Y,"Kenya");Y+=10;doc.setLineWidth(1.5);doc.line(X,Y,290,Y);Y+=20;doc.setFillColor(222,234,242);doc.rect(X,Y,290,10,"F");Y+=10;Y-=4;WIDTH=300;doc.setTextColor(77,150,202);const x1=X;doc.text(x1,Y,"ITEM");const x2=x1+.4*WIDTH;doc.text(x2,Y,"QTY");const x3=x2+.2*WIDTH;doc.text(x3,Y,"RATE");const x4=x3+.2*WIDTH;doc.text(x4,Y,"AMOUNT");doc.setTextColor(31,8,34);Y+=10;for(var i=0;i<self.items.length;i++){const item=self.items[i];Y+=LINE_HEIGHT;doc.setFontType("bold");doc.text(x1,Y,item.name);doc.setFontType("normal");doc.text(x2,Y,item.quantity.toString());doc.text(x3,Y,item.unit_price.toString());doc.text(x4,Y,item.sub_total.toString())}Y+=20;doc.setDrawColor(255,0,0);doc.setLineWidth(1.3);this.dottedLine(doc,X,Y,300,Y,8);Y+=LINE_HEIGHT;doc.text(x1,Y,"Final amount for order .");Y+=10;const INDENT=200;doc.text(INDENT,Y,"PAYMENT");doc.text(INDENT+50,Y,self._getColumnTotal("cart_item__total")+"");Y+=LINE_HEIGHT;doc.text(INDENT,Y,"BALANCE DUE");doc.setFontType("bold");doc.text(INDENT+50,Y,"$0.00");doc.setFontType("normal");doc.setFontSize(60);doc.setTextColor(0,255,0);doc.text(100,140,"PAID",null,35);if(autoPrint){doc.autoPrint();var iframe=this.qs("#iframe");iframe.src=doc.output("dataurlstring")}else{doc.save("Invoice"+self.reference+".pdf")}}dottedLine(doc,xFrom,yFrom,xTo,yTo,segmentLength){var _Mathfloor=Math.floor,_Mathpow=Math.pow,_Mathabs=Math.abs,a=_Mathabs(xTo-xFrom),b=_Mathabs(yTo-yFrom),c=Math.sqrt(_Mathpow(a,2)+_Mathpow(b,2)),fractions=c/segmentLength,adjustedSegmentLength=0===_Mathfloor(fractions)%2?c/Math.ceil(fractions):c/_Mathfloor(fractions),deltaX=adjustedSegmentLength*(a/c),deltaY=adjustedSegmentLength*(b/c),curX=xFrom,curY=yFrom;while(curX<=xTo&&curY<=yTo){doc.line(curX,curY,curX+deltaX,curY+deltaY);curX+=2*deltaX;curY+=2*deltaY}}init(pElement,loader){super.init(pElement,loader);var self=this;self.service=pElement.service;self.params=loader.pl.paramsCopy();if(pElement.defaultValue){const defaultValueAr=pElement.defaultValue.split("=");self.invoice=defaultValueAr[1]}self.reference=pElement.kind||"";self.loader=this.loadData()}};