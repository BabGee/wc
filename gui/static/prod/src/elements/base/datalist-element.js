import{mqttMixin}from"../../core/mixins/mqtt-mixin.js";import{dataSourceMixin}from"../../core/mixins/datasource-mixin.js";import{utilsMixin}from"../../core/mixins/utils-mixin.js";import{SerializableElement}from"../../core/serializable-element.js";import{format,parseISO}from"../../../node_modules/date-fns/esm/index.js";import"../../../node_modules/jspdf/dist/jspdf.min.js";import{default as AutoTable}from"../../core/libs/autotable/main.js";import{Logger}from"../../core/logger.js";export const DataListElementBase=class extends utilsMixin(dataSourceMixin(mqttMixin(SerializableElement))){static get is(){return"datalist-element"}constructor(){super();this.limit=50}static get properties(){return{table:{type:Boolean,value:!0},grid:{type:Boolean,value:!1},list:{type:Boolean,value:!1},sortProperty:{type:String},selectedRows:{type:Array,value:[]},showActions:{type:Boolean,value:!1,notify:!0}}}dscDataName(){return this.e.defaultValue}firstUpdated(changedProperties){super.firstUpdated(changedProperties);const self=this;if(self.e.kind){try{self.register(self,self.e.kind)}catch(e){console.error(e)}}this.loader.then(()=>{})}_handlePageChanged(event){event.preventDefault();this.page=event.detail.page;this.loadData().then(()=>{})}_handleLimitChanged(event){event.preventDefault();this.limit=event.detail.size;this.loadData().then(()=>{})}_handleSort(event){event.preventDefault();this.sortProperty=event.detail.sort.property+","+event.detail.sort.direction}_handleFilterTh(event){var column=event.detail.column;console.log(column)}_handleFilter(event){var filter=event.detail.filter.value,column=event.detail.column;this.updateParams(column.propertyPath,filter)}_handleDFilter(event){var filter=event.detail.value,column=event.detail.path;if(filter){this.updateParams(column,filter)}}_handleSearch(event){var filter=event.detail.value,column=event.detail.column,columns=event.detail.searchFields;this.deleteParamKeys(columns.concat(["q"]),!1);this.updateParams(column,filter)}_handleDateRangeChange(event){var filter=event.detail.range;this.$.datasource.mergeParams(filter)}_handleSelectionChanged(event){if(event.detail.selected){this.actionRow=event.detail.data;this.showActions=!0}else{this.showActions=!1}}_processTemplateLiteral(literal){const content=literal.substring(1,literal.length-1),columns=content.split("("),column=columns[0],columns2=columns[1].split(")"),extreme=columns2[0],tokens=columns2[1].substring(1);for(let i=0;i<this.cols.length;i++){const col=this.cols[i];if(col.label===column){let dateString;if("MIN"===extreme.toUpperCase()){dateString=this.rows[0][i]}else if("MAX"===extreme.toUpperCase()){dateString=this.rows[this.rows.length-1][i]}let date;if("datetime"===col.type||"date"===col.type){date=dateString?format(parseISO(dateString),tokens):""}return date}}Logger.i.switchConfiguration(`${column} is not a valid column for the export file name, 
      Valid options are ${this.cols.map(c=>c.label).join(",")}`);return""}_processExportFileNameTemplate(tpl){const re=/\[([^\]]+)?]/g;let match;const matches=tpl.match(re);for(let i=0;i<matches.length;i++){match=matches[i];tpl=tpl.replace(match,this._processTemplateLiteral(match))}return tpl}generateCSV(){const self=this,SEPARATOR=",";let csvContent="data:text/csv;charset=utf-8,";const headers=this.cols.filter(col=>"href"!=col.type).map(function(i){return i.label}),row=headers.join(SEPARATOR);csvContent+=row+"\r\n";this.rows.forEach(function(row){const rowArray=[];for(let i=0;i<self.cols.length;i++){const colType=self.cols[i].type;if("href"!==colType){const columnValue=row[i];if("string"===colType&&"string"===typeof columnValue){rowArray.push(columnValue.replace(/[#,]/g," "))}else{rowArray.push(columnValue)}}}row=rowArray.join(SEPARATOR);csvContent+=row+"\r\n"});var encodedUri=encodeURI(csvContent),link=document.createElement("a");link.setAttribute("href",encodedUri);if("export"in this.e.details){link.setAttribute("download",this._processExportFileNameTemplate(this.e.details["export"].csv.filename))}else{link.setAttribute("download",this.e.defaultValue+".csv")}document.body.appendChild(link);link.click()}_validateType(x){return"type"in x?x.type.toLowerCase():"table"}_validatePageLimits(x){return"page_limits"in x?x.page_limits:[]}generatePDF(){const self=this;var doc=new jsPDF("l","pt");const rows=[];this.rows.forEach(function(row){const rowArray=[];for(let i=0;i<self.cols.length;i++){if("href"!=self.cols[i].type){rowArray.push(row[i])}}rows.push(rowArray)});const table=new AutoTable(doc);table.autoTable(this.cols.filter(col=>"href"!=col.type).map(function(i){return i.label}),rows,{theme:"grid",styles:{overflow:"linebreak"},columnStyles:{text:{columnWidth:"auto"}},margin:{top:10,horizontal:7}});if("export"in this.e.details){doc.save(this._processExportFileNameTemplate(this.e.details["export"].pdf.filename))}else{doc.save(this.e.defaultValue+".pdf")}}onMqttMessage(message){super.onMqttMessage(message);var self=this;console.log("datalist on-mqtt-message");var payload=JSON.parse(message.payloadString);console.info(payload);self.parseResponseIntoProperties(payload)}validate(){return new this.Validation(!0,"valid")}getName(){return this.e.formName}getValue(){return null}valid(){}invalid(){}init(pElement,loader){super.init(pElement,loader);const self=this;self.required=this.e.required||pElement.min&&0<pElement.min;self.title=DataListElementBase.toTitleCase(pElement.name);self.params=loader.pl.paramsCopy();if("selectable"in this.e.details){self.selectable=this.e.details.selectable}self.loader=this.loadData()}};